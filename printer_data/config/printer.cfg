[include mainsail.cfg]
[include Stealthburner_Barf_LED.cfg]
[include Custom_Macros.cfg]
[include WLED.cfg]
[include MainSail_Client_Variable.cfg]
[include timelapse.cfg]

########################################
# MCUs
########################################

[mcu]
canbus_uuid: 9c5c97fee7df


[mcu EBB]
canbus_uuid: 27fc0ec6590a


[mcu scanner]
# canbus_uuid: 0ca8d67388c2 
# serial: /dev/serial/by-id/usb-cartographer_cartographer_
#    adjust to suit your scanner, if using usb change to serial
serial: /dev/serial/by-id/usb-Cartographer_614e_390042001853584833373720-if00

[printer]
kinematics: corexy
max_z_accel: 150
max_accel: 8000
max_z_velocity: 15
max_velocity: 350

#[adxl345]
#cs_pin: scanner:PA3
#spi_bus: spi1

#[resonance_tester]
#accel_chip: adxl345
#probe_points:
#    125, 125, 20

[input_shaper]
shaper_freq_x: 70.4
shaper_type_x: mzv
shaper_freq_y: 53.0
shaper_type_y: mzv

[virtual_sdcard]
path: /home/pi/printer_data/gcodes
[display_status]
[pause_resume]


########################################
# Micro-Controller Temperature
########################################

[temperature_sensor Board_MCU]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor EBB]
sensor_type: Generic 3950
sensor_pin: EBB:gpio28
min_temp: 0
max_temp: 100

# S1
[stepper_x]
step_pin: PC14
dir_pin: !PC13
enable_pin: !PE6
microsteps: 64
full_steps_per_rotation:200
rotation_distance: 40
endstop_pin: EBB:gpio24
position_endstop: 250
position_min: 0
position_max: 250
homing_speed: 70
homing_retract_dist: 10
homing_positive_dir: true

# S2
[stepper_y]
step_pin: PE5
dir_pin: !PE4
enable_pin: !PE3
microsteps: 64
full_steps_per_rotation:200
rotation_distance: 40
endstop_pin: PF0
position_endstop: 250
position_min: 0
position_max: 250
homing_speed: 70
homing_retract_dist: 10
homing_positive_dir: true

########################################
# Z Steppers
########################################

# S5
[stepper_z]
step_pin: PG9
dir_pin: !PG10
enable_pin: !PG13
microsteps: 64
rotation_distance: 40
gear_ratio: 80:16
endstop_pin: probe:z_virtual_endstop
position_max: 210
position_min: -5
homing_speed: 10
second_homing_speed: 5
homing_retract_dist: 0

# S6
[stepper_z1]
step_pin: PG11
dir_pin: PD7
enable_pin: !PG12
microsteps: 64
rotation_distance: 40
gear_ratio: 80:16

# S7
[stepper_z2]
step_pin: PB4
dir_pin: !PB3
enable_pin: !PB5
microsteps: 64
rotation_distance: 40
gear_ratio: 80:16

# S8
[stepper_z3]
step_pin: PG15
dir_pin: PB6
enable_pin: !PG14
microsteps: 64
rotation_distance: 40
gear_ratio: 80:16

########################################
# TMC2160 configuration
########################################

[tmc5160 stepper_x]
cs_pin: PD6
spi_software_sclk_pin: PC6
spi_software_mosi_pin: PC8
spi_software_miso_pin: PC7
#diag1_pin: PC15
run_current: 1.5
# hold_current: 0.9
sense_resistor: 0.022
# stealthchop_threshold: 999999

[tmc5160 stepper_y]
cs_pin: PD5
spi_software_sclk_pin: PC6
spi_software_mosi_pin: PC8
spi_software_miso_pin: PC7
#diag1_pin: PF0
run_current: 1.5
# hold_current: 0.9
sense_resistor: 0.022
# stealthchop_threshold: 999999


[tmc5160 stepper_z]
cs_pin: PD2
spi_software_sclk_pin: PC6
spi_software_mosi_pin: PC8
spi_software_miso_pin: PC7
run_current: 0.800
sense_resistor: 0.075
# stealthchop_threshold: 999999

[tmc5160 stepper_z1]
cs_pin: PA15
spi_software_sclk_pin: PC6
spi_software_mosi_pin: PC8
spi_software_miso_pin: PC7
run_current: 0.800
sense_resistor: 0.075
#stealthchop_threshold: 999999

[tmc5160 stepper_z2]
cs_pin: PA9
spi_software_sclk_pin: PC6
spi_software_mosi_pin: PC8
spi_software_miso_pin: PC7
run_current: 0.800
sense_resistor: 0.075
#stealthchop_threshold: 999999

[tmc5160 stepper_z3]
cs_pin: PA10
spi_software_sclk_pin: PC6
spi_software_mosi_pin: PC8
spi_software_miso_pin: PC7
run_current: 0.800
sense_resistor: 0.075
#stealthchop_threshold: 999999

########################################

########################################
#   Extruder
########################################

[extruder]
step_pin: EBB:gpio18
dir_pin: EBB:gpio19
enable_pin: !EBB:gpio17
microsteps: 16

rotation_distance: 47.088 ## # For Galileo 2 Extruder
gear_ratio: 9:1

full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_only_distance: 500
max_extrude_only_velocity: 120
max_extrude_cross_section: 5
heater_pin: EBB:gpio7
sensor_type: Generic 3950
sensor_pin: EBB:gpio27
# pid_version = 1
# pid_target = 240.00
# pid_tolerance = 0.0200
control = pid
pid_kp = 18.287
pid_ki = 1.729
pid_kd = 48.346
min_temp: 10
min_extrude_temp: 180
max_temp: 300
pressure_advance: 0.02
pressure_advance_smooth_time: 0.040

[tmc2209 extruder]
uart_pin: EBB:gpio20
interpolate: false
run_current: 0.80
hold_current: 0.600
sense_resistor: 0.11
stealthchop_threshold: 0
# stealthchop_threshold: 999999
driver_TBL: 0
driver_HEND: 6
driver_HSTRT: 7
driver_TOFF: 4

########################################

[heater_bed]
heater_pin: PF7
sensor_pin: PB0 # TB
sensor_type: Generic 3950
#control: watermark
min_temp: 0
max_temp: 110
max_power: 0.75
# pid_version = 1
# pid_target = 100.00
# pid_tolerance = 0.0200
control = pid
pid_kp = 42.129
pid_ki = 1.483
pid_kd = 299.113

[temperature_sensor Chamber_Sensor]
sensor_pin: PC5
sensor_type: Generic 3950
min_temp: 0
max_temp: 90

[fan]
pin: EBB:gpio13

[heater_fan hotend_fan]
pin: EBB:gpio14
max_power: 1.0
heater: extruder
heater_temp: 50.0

[fan_generic Bed_Fan]
pin: PA4


########################################
#   Probe
########################################

# [probe]
# pin: PC15 ### <=== CHANGE THIS !!!!!
# x_offset: 0
# y_offset: 0
# #z_offset = 8.860
# speed: 10.0
# samples: 1
# samples_result: median
# sample_retract_dist: 2.0
# samples_tolerance: 0.01
# samples_tolerance_retries: 3

# # Below is for TAP alone
# activate_gcode:
#     {% set PROBE_TEMP = 150 %}
#     {% set MAX_TEMP = PROBE_TEMP + 5 %}
#     {% set ACTUAL_TEMP = printer.extruder.temperature %}
#     {% set TARGET_TEMP = printer.extruder.target %}

#     {% if TARGET_TEMP > PROBE_TEMP %}
#         { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#         M109 S{ PROBE_TEMP }
#     {% else %}
#         # Temperature target is already low enough, but nozzle may still be too hot.
#         {% if ACTUAL_TEMP > MAX_TEMP %}
#             { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#             TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#         {% endif %}
#     {% endif %}


########################################

########################################
#   Cartographer
########################################

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 20                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.00692
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 125, 125    
#    set this to the middle of your bed
speed: 200
#    movement speed of toolhead during bed mesh
horizontal_move_z: 5
#    height of scanner during bed mesh scan
mesh_min: 15, 26
#    start point of bed mesh [X, Y]
mesh_max: 240, 220
#    end point of bed mesh [X, Y]
probe_count: 20, 20
algorithm: bicubic

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105


########################################
#  Homing and Gantry Adjustment Routines
########################################

[idle_timeout]
timeout: 28800


[safe_z_home]
home_xy_position: 125,125 
speed: 100
z_hop: 10
Z_hop_speed: 10

[quad_gantry_level]
gantry_corners:
    -60,-10
    310, 320
points:
    25,5
    25,195
    225,195
    225,5
speed: 100
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.05
max_adjust: 10


########################################
#   BED MESH
########################################


# [bed_mesh]
# speed: 200
# horizontal_move_z: 15
# mesh_min: 5,20
# mesh_max: 240,195
# probe_count: 9, 9
# algorithm: bicubic

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = -1.115
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 2750
#*# scanner_touch_speed = 3
#*#
#*# [scanner model default]
#*# model_coef = 1.5064870358320182,
#*# 	  1.8182647050392513,
#*# 	  0.7422415624240304,
#*# 	  0.2958432654208879,
#*# 	  0.3793445168378198,
#*# 	  0.5681432736540885,
#*# 	  -0.24236647411840093,
#*# 	  -0.5677807153272539,
#*# 	  0.26420211433570917,
#*# 	  0.3367167936745417
#*# model_domain = 3.1925724977196416e-07,3.3460030880277166e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 33.900772
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.017103, -0.003886, 0.000515, -0.015192, -0.046168, -0.062026, -0.067216, -0.062563, -0.046410, -0.031608, -0.027856, -0.019575, 0.000322, 0.011834, 0.020118, 0.009778, -0.010903, -0.010865, -0.015777, -0.042956
#*# 	  -0.002273, 0.010217, 0.012254, -0.002931, -0.031006, -0.044691, -0.054358, -0.053352, -0.030636, -0.013624, -0.010239, 0.000508, 0.015534, 0.031811, 0.035067, 0.024764, 0.012453, 0.003434, 0.000377, -0.029402
#*# 	  0.004624, 0.014328, 0.023201, 0.010043, -0.021368, -0.040698, -0.047802, -0.040161, -0.020326, -0.005362, -0.000888, 0.006466, 0.019315, 0.031756, 0.040750, 0.030223, 0.019953, 0.010135, 0.007199, -0.014714
#*# 	  0.006392, 0.021615, 0.029870, 0.015330, -0.014428, -0.029550, -0.035689, -0.030416, -0.009530, 0.002018, 0.003256, 0.013301, 0.026277, 0.039647, 0.048181, 0.043655, 0.029104, 0.021421, 0.017100, -0.009285
#*# 	  0.010681, 0.026306, 0.032324, 0.020351, -0.010184, -0.022863, -0.026576, -0.021323, -0.000935, 0.009576, 0.014025, 0.021580, 0.035929, 0.048486, 0.056338, 0.050174, 0.038295, 0.031673, 0.025255, -0.000122
#*# 	  0.009889, 0.027545, 0.037567, 0.023375, -0.005977, -0.017981, -0.018576, -0.013153, 0.005126, 0.014809, 0.021986, 0.029817, 0.042500, 0.054942, 0.059823, 0.054630, 0.043630, 0.037539, 0.029990, 0.007039
#*# 	  0.009397, 0.026481, 0.038839, 0.026254, -0.006180, -0.015975, -0.014824, -0.012834, 0.006129, 0.015728, 0.024324, 0.033968, 0.043750, 0.056856, 0.064223, 0.058366, 0.046418, 0.038730, 0.028691, 0.006117
#*# 	  0.008234, 0.025190, 0.037788, 0.027395, -0.004727, -0.015733, -0.014933, -0.014535, 0.000433, 0.015694, 0.022790, 0.032420, 0.044821, 0.055443, 0.058024, 0.055742, 0.045021, 0.039462, 0.031121, 0.005735
#*# 	  0.002457, 0.021310, 0.034999, 0.023898, -0.005614, -0.016775, -0.017643, -0.016085, -0.002984, 0.010860, 0.019904, 0.028078, 0.038556, 0.050160, 0.053690, 0.052054, 0.044247, 0.036655, 0.030493, 0.004155
#*# 	  0.000355, 0.018266, 0.031807, 0.018801, -0.005853, -0.018919, -0.021505, -0.019088, -0.006718, 0.008967, 0.017656, 0.024960, 0.035115, 0.047040, 0.052415, 0.050014, 0.041315, 0.030091, 0.025194, -0.000259
#*# 	  0.001296, 0.018016, 0.028303, 0.020195, -0.007150, -0.020249, -0.023467, -0.020813, -0.007750, 0.008552, 0.017077, 0.026118, 0.035552, 0.046954, 0.052199, 0.047516, 0.039332, 0.027514, 0.019554, -0.001883
#*# 	  0.008019, 0.022744, 0.027945, 0.020719, -0.006530, -0.022361, -0.024481, -0.020358, -0.008894, 0.010290, 0.019850, 0.028887, 0.038206, 0.047519, 0.052767, 0.046268, 0.037340, 0.024559, 0.018658, -0.004100
#*# 	  0.002352, 0.018595, 0.026339, 0.019314, -0.008457, -0.020650, -0.026775, -0.022983, -0.009083, 0.009138, 0.016099, 0.027350, 0.038155, 0.047133, 0.050360, 0.041316, 0.031511, 0.020047, 0.014177, -0.009226
#*# 	  -0.001588, 0.015838, 0.025840, 0.015747, -0.009833, -0.022888, -0.029350, -0.026957, -0.012684, 0.004778, 0.012570, 0.021474, 0.035867, 0.043566, 0.048204, 0.037335, 0.027293, 0.014710, 0.008940, -0.015197
#*# 	  -0.003468, 0.011407, 0.019780, 0.011780, -0.013437, -0.028917, -0.033280, -0.032693, -0.016638, 0.001224, 0.006920, 0.014999, 0.030567, 0.035679, 0.040312, 0.031591, 0.017554, 0.007943, 0.000091, -0.024404
#*# 	  -0.005033, 0.007996, 0.012168, 0.006195, -0.022530, -0.036365, -0.040165, -0.036781, -0.020792, -0.006619, -0.002804, 0.008644, 0.024477, 0.029737, 0.034822, 0.026042, 0.014945, 0.001685, -0.004776, -0.026181
#*# 	  -0.010529, 0.001020, 0.007751, -0.000764, -0.024724, -0.039403, -0.045873, -0.040951, -0.024551, -0.012913, -0.009597, 0.000322, 0.019530, 0.029508, 0.030482, 0.023196, 0.005726, -0.006998, -0.012798, -0.037159
#*# 	  -0.012749, 0.000274, 0.003058, -0.007464, -0.031667, -0.044381, -0.052492, -0.047360, -0.031915, -0.021245, -0.019181, -0.009392, 0.013156, 0.021763, 0.023478, 0.019726, 0.005014, -0.010923, -0.021782, -0.046498
#*# 	  -0.010838, -0.001967, -0.000586, -0.011386, -0.034985, -0.051037, -0.057140, -0.055333, -0.040540, -0.032875, -0.028830, -0.016189, 0.006034, 0.015196, 0.015129, 0.013060, -0.001621, -0.018905, -0.028228, -0.053046
#*# 	  -0.014352, -0.002290, -0.003708, -0.012658, -0.037506, -0.053238, -0.060622, -0.060433, -0.051124, -0.039069, -0.032055, -0.020766, -0.004518, 0.008667, 0.011689, 0.008658, -0.004103, -0.018007, -0.025238, -0.051708
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 35.0
#*# max_x = 240.0
#*# min_y = 26.0
#*# max_y = 220.0
